{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "809ed813",
   "metadata": {},
   "source": [
    "# Blazar-neutrino connected simulation\n",
    "\n",
    "We demonstrate how to run a simulation for a population of blazars that produce neutrinos according to their gamma-ray fluxes in the 0.1 to 100 GeV range."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "34fc4d78",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2022-01-19T10:51:47.131987Z",
     "iopub.status.busy": "2022-01-19T10:51:47.131562Z",
     "iopub.status.idle": "2022-01-19T10:51:50.614612Z",
     "shell.execute_reply": "2022-01-19T10:51:50.613629Z"
    }
   },
   "outputs": [],
   "source": [
    "from popsynth.utils.logging import quiet_mode\n",
    "from icecube_tools.detector.effective_area import EffectiveArea\n",
    "from icecube_tools.detector.energy_resolution import EnergyResolution\n",
    "from icecube_tools.detector.angular_resolution import AngularResolution\n",
    "\n",
    "from nu_coincidence.blazar_nu.connected import BlazarNuConnectedSim\n",
    "from nu_coincidence.blazar_nu.connected import BlazarNuConnectedResults\n",
    "from nu_coincidence.utils.package_data import get_available_config\n",
    "\n",
    "quiet_mode()  # silence popsynth logs/output"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a70437fd",
   "metadata": {},
   "source": [
    "Firstly, we make sure that we have the necessary files for running an IceCube simulation by using the `icecube_tools` package"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "b6006865",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2022-01-19T10:51:50.619307Z",
     "iopub.status.busy": "2022-01-19T10:51:50.618782Z",
     "iopub.status.idle": "2022-01-19T10:51:55.735948Z",
     "shell.execute_reply": "2022-01-19T10:51:55.736705Z"
    }
   },
   "outputs": [],
   "source": [
    "my_aeff = EffectiveArea.from_dataset(\"20181018\")\n",
    "my_aeff = EffectiveArea.from_dataset(\"20131121\")\n",
    "my_eres = EnergyResolution.from_dataset(\"20150820\")\n",
    "my_angres = AngularResolution.from_dataset(\"20181018\")"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "23baf2e5",
   "metadata": {},
   "source": [
    "The inputs to `BlazarNuConnectedSim` are specified by the `.yml` config files provided with the `nu_coincidence` package. We can check what is available using the helper function `get_available_config()`."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "228498fb",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2022-01-19T10:51:55.742239Z",
     "iopub.status.busy": "2022-01-19T10:51:55.741750Z",
     "iopub.status.idle": "2022-01-19T10:51:55.749633Z",
     "shell.execute_reply": "2022-01-19T10:51:55.750017Z"
    }
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "['nu_connected_ehe.yml',\n",
       " 'nu_diffuse_ehe_soft.yml',\n",
       " 'fsrq_low.yml',\n",
       " 'fsrq_ref.yml',\n",
       " 'bllac_high.yml',\n",
       " 'bllac_nobcu.yml',\n",
       " 'nu_diffuse_tracks.yml',\n",
       " 'nu_connected_hese.yml',\n",
       " 'nu_diffuse_hese_soft.yml',\n",
       " 'fsrq_high.yml',\n",
       " 'bllac_rbcu.yml',\n",
       " 'nu_diffuse_ehe.yml',\n",
       " 'bllac_ref.yml',\n",
       " 'fsrq_gpsel.yml',\n",
       " 'fsrq_nobcu.yml',\n",
       " 'nu_diffuse_hese.yml',\n",
       " 'bllac_gpsel.yml',\n",
       " 'nu_connected_tracks.yml',\n",
       " 'nu_diffuse_ehe_hard.yml',\n",
       " 'fsrq_rbcu.yml',\n",
       " 'bllac_low.yml',\n",
       " 'nu_diffuse_hese_hard.yml']"
      ]
     },
     "execution_count": 3,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "get_available_config()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "42bef04d",
   "metadata": {},
   "source": [
    "The connecting flux factor, $Y_{\\nu\\gamma}$ can be set in the `nu_connected_...` config files or specified at run time. we may want to explore different flux factors and their implications, as we show below."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "51c93da0",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2022-01-19T10:51:55.753391Z",
     "iopub.status.busy": "2022-01-19T10:51:55.752910Z",
     "iopub.status.idle": "2022-01-19T10:51:55.755386Z",
     "shell.execute_reply": "2022-01-19T10:51:55.754922Z"
    }
   },
   "outputs": [],
   "source": [
    "flux_factors = [0.001, 0.01]\n",
    "sub_file_names = [\"output/test_connected_sim_%.1e.h5\" % ff for ff in flux_factors]"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "a4b11fd5",
   "metadata": {},
   "source": [
    "For this example, we use the reference blazar model (`bllac_ref.yml` and `fsrq_ref.yml`) together with the connected IceCube HESE and EHE alerts models (`nu_connected_hese.yml` and `nu_connected_ehe.yml`). This will run for a couple of mins."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "7e4d6f29",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2022-01-19T10:51:55.760020Z",
     "iopub.status.busy": "2022-01-19T10:51:55.759486Z",
     "iopub.status.idle": "2022-01-19T10:55:10.732225Z",
     "shell.execute_reply": "2022-01-19T10:55:10.731140Z"
    }
   },
   "outputs": [],
   "source": [
    "for ff, sfn in zip(flux_factors, sub_file_names):\n",
    "    sim = BlazarNuConnectedSim(\n",
    "        file_name=\"output/test_connected_sim_%.1e.h5\" % ff,\n",
    "        N=2,  # Number of sims to run\n",
    "        bllac_config=\"bllac_ref.yml\",\n",
    "        fsrq_config=\"fsrq_ref.yml\",\n",
    "        nu_hese_config=\"nu_connected_hese.yml\",\n",
    "        nu_ehe_config=\"nu_connected_ehe.yml\",\n",
    "        seed=42,\n",
    "        flux_factor=ff,\n",
    "        flare_only=True,  # only flare emission contributes\n",
    "        det_only=True,\n",
    "    )  # only detected blazars contribute\n",
    "\n",
    "    sim.run(parallel=False)  # define number of parallel jobs to run"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "4f8f4ee1",
   "metadata": {},
   "source": [
    "If working with different flux factors, there is a helper function to merge together the separate output files."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "e1da4bde",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2022-01-19T10:55:10.738467Z",
     "iopub.status.busy": "2022-01-19T10:55:10.737935Z",
     "iopub.status.idle": "2022-01-19T10:55:10.756736Z",
     "shell.execute_reply": "2022-01-19T10:55:10.756184Z"
    }
   },
   "outputs": [],
   "source": [
    "BlazarNuConnectedResults.merge_over_flux_factor(\n",
    "    sub_file_names, flux_factors, write_to=\"output/test_connected_sim.h5\", delete=True\n",
    ")\n",
    "\n",
    "results = BlazarNuConnectedResults([\"output/test_connected_sim.h5\"])"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "fe7fb9a5",
   "metadata": {},
   "source": [
    "The results are organised to store relevant information divided into the `results.bllac` and `results.fsrq` populations. We focus on the total number of alerts, `n_alerts`, and the number of sources that produce multiple detected neutrinos, `n_multi`, from each simulated survey."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "6d0135a1",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2022-01-19T10:55:10.763195Z",
     "iopub.status.busy": "2022-01-19T10:55:10.762321Z",
     "iopub.status.idle": "2022-01-19T10:55:10.764870Z",
     "shell.execute_reply": "2022-01-19T10:55:10.765276Z"
    }
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "OrderedDict([('n_alerts',\n",
       "              array([[0, 0],\n",
       "                     [0, 0]])),\n",
       "             ('n_alerts_flare',\n",
       "              array([[0, 0],\n",
       "                     [0, 0]])),\n",
       "             ('n_multi',\n",
       "              array([[0, 0],\n",
       "                     [0, 0]])),\n",
       "             ('n_multi_flare',\n",
       "              array([[0, 0],\n",
       "                     [0, 0]]))])"
      ]
     },
     "execution_count": 7,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "results.bllac"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "a7c2db0f",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2022-01-19T10:55:10.770567Z",
     "iopub.status.busy": "2022-01-19T10:55:10.770112Z",
     "iopub.status.idle": "2022-01-19T10:55:10.773857Z",
     "shell.execute_reply": "2022-01-19T10:55:10.774257Z"
    }
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "OrderedDict([('n_alerts',\n",
       "              array([[0, 0],\n",
       "                     [0, 0]])),\n",
       "             ('n_alerts_flare',\n",
       "              array([[0, 0],\n",
       "                     [0, 0]])),\n",
       "             ('n_multi',\n",
       "              array([[0, 0],\n",
       "                     [0, 0]])),\n",
       "             ('n_multi_flare',\n",
       "              array([[0, 0],\n",
       "                     [0, 0]]))])"
      ]
     },
     "execution_count": 8,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "results.fsrq"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "cb31ff9f",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.9.9"
  },
  "widgets": {
   "application/vnd.jupyter.widget-state+json": {
    "state": {
     "160d80fbf891423fbdd44404f9fbbd50": {
      "model_module": "jupyter-vuetify",
      "model_module_version": "^1.8.1",
      "model_name": "ThemeColorsModel",
      "state": {
       "_model_module": "jupyter-vuetify",
       "_model_module_version": "^1.8.1",
       "_model_name": "ThemeColorsModel",
       "_theme_name": "dark",
       "_view_count": null,
       "_view_module": null,
       "_view_module_version": "^1.8.1",
       "_view_name": null,
       "accent": "#FF4081",
       "anchor": null,
       "error": "#FF5252",
       "info": "#2196F3",
       "primary": "#2196F3",
       "secondary": "#424242",
       "success": "#4CAF50",
       "warning": "#FB8C00"
      }
     },
     "4232b0d7913d4694b02fcf863ead6ee1": {
      "model_module": "jupyter-vuetify",
      "model_module_version": "^1.8.1",
      "model_name": "ThemeColorsModel",
      "state": {
       "_model_module": "jupyter-vuetify",
       "_model_module_version": "^1.8.1",
       "_model_name": "ThemeColorsModel",
       "_theme_name": "light",
       "_view_count": null,
       "_view_module": null,
       "_view_module_version": "^1.8.1",
       "_view_name": null,
       "accent": "#82B1FF",
       "anchor": null,
       "error": "#FF5252",
       "info": "#2196F3",
       "primary": "#1976D2",
       "secondary": "#424242",
       "success": "#4CAF50",
       "warning": "#FB8C00"
      }
     },
     "8fbc6f5c75aa43589d42b21b2dfb3f39": {
      "model_module": "@jupyter-widgets/base",
      "model_module_version": "1.2.0",
      "model_name": "LayoutModel",
      "state": {
       "_model_module": "@jupyter-widgets/base",
       "_model_module_version": "1.2.0",
       "_model_name": "LayoutModel",
       "_view_count": null,
       "_view_module": "@jupyter-widgets/base",
       "_view_module_version": "1.2.0",
       "_view_name": "LayoutView",
       "align_content": null,
       "align_items": null,
       "align_self": null,
       "border": null,
       "bottom": null,
       "display": null,
       "flex": null,
       "flex_flow": null,
       "grid_area": null,
       "grid_auto_columns": null,
       "grid_auto_flow": null,
       "grid_auto_rows": null,
       "grid_column": null,
       "grid_gap": null,
       "grid_row": null,
       "grid_template_areas": null,
       "grid_template_columns": null,
       "grid_template_rows": null,
       "height": null,
       "justify_content": null,
       "justify_items": null,
       "left": null,
       "margin": null,
       "max_height": null,
       "max_width": null,
       "min_height": null,
       "min_width": null,
       "object_fit": null,
       "object_position": null,
       "order": null,
       "overflow": null,
       "overflow_x": null,
       "overflow_y": null,
       "padding": null,
       "right": null,
       "top": null,
       "visibility": null,
       "width": null
      }
     },
     "98ec2af3164a4feca7b4bf0cf5c7c7a9": {
      "model_module": "jupyter-vuetify",
      "model_module_version": "^1.8.1",
      "model_name": "ThemeModel",
      "state": {
       "_model_module": "jupyter-vuetify",
       "_model_module_version": "^1.8.1",
       "_model_name": "ThemeModel",
       "_view_count": null,
       "_view_module": null,
       "_view_module_version": "^1.8.1",
       "_view_name": null,
       "dark": null
      }
     },
     "c1e8239514754f64abde727bbb85c89e": {
      "model_module": "jupyter-vue",
      "model_module_version": "^1.7.0",
      "model_name": "ForceLoadModel",
      "state": {
       "_dom_classes": [],
       "_model_module": "jupyter-vue",
       "_model_module_version": "^1.7.0",
       "_model_name": "ForceLoadModel",
       "_view_count": null,
       "_view_module": null,
       "_view_module_version": "",
       "_view_name": null,
       "layout": "IPY_MODEL_8fbc6f5c75aa43589d42b21b2dfb3f39"
      }
     }
    },
    "version_major": 2,
    "version_minor": 0
   }
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
